!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Automator=e()}(this,function(){function t(t){return t&&"function"==typeof t.done&&"function"==typeof t.fail&&"function"==typeof t.always}function e(t){return"isArray"in Array?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)}function n(i){function o(){if(i.debug){var t=Array.prototype.slice.call(arguments);t.unshift("Automator.js: "),console.log.apply(console,t)}}function r(){l=[],d=[],h=0,p=1,y=0,b=new i.Deferred,v=!1}function u(t,e){return"number"==typeof e&&e>0?(o("Sleeping for "+e+"ms"),setTimeout.bind(null,t,e)):t}function s(n,i){t(i)?(o("Deferring next step until the promise is resolved"),i.always(n)):e(i)?(i.length>0&&(o("Received back an array of interim actions, running them now: ",i),d.unshift(i)),n()):(o("Passing value through to next step: ",i),n(i))}function a(t){var e,n,r,f,c,g,w;if(v)return void o("was killed by user, exiting.");if(h>=l.length)return o("iteration "+y+" completed"),"function"==typeof m&&(o("Executing iteration callback"),c=m(y)),++y>=p?(o("Done with iterations"),void s(b.resolve,c)):(o("Automator iteration "+y+" ready to start"),h=0,w=u(a,i.iterationDelay),void s(w,c));if(d.length>0?(n=d[0].shift(),0===d[0].length&&d.shift()):n=l[h++],e=d.length>0?d[0][0]:l[h],null==n)return o("Skipping null action"),void a();if(o("Handling action: "+n),r=typeof n,"number"===r)f=i.doNumber;else if("string"===r)f=i.doString;else{if("function"!==r)throw"Unsupported type!";f=i.doFunction}g="number"===r||"number"==typeof e||null==e?0:i.stepDelay,w=u(a,g),c=f.call(null,n,t),s(w,c)}function f(t){for(var e,n,i,o=[],r=-1,u=t.length;++r<u;)if(e=t[r],"string"==typeof e&&(n=e.match(/(.*)+x(\d+)$/),n&&3===n.length))for(e=n[1],i=parseInt(n[2],10);i-->0;)o.push(e);else o.push(e);return o}var c,l,d,h,p,y,m,b,v;i="object"==typeof i?i:{};for(c in n.defaults)("undefined"==typeof i[c]||i[null===c])&&(i[c]=n.defaults[c]);this.automate=function(t,e,n){return e="number"==typeof e?e:1,r(),l=f(t),p=e,m=n,a(),b.promise()},this.kill=function(){v=!0}}return n.keyCodeMap={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,left:37,up:38,right:39,down:40,enter:13,tab:9,ctrl:17,esc:27,space:32},n.doNumber=function(t,e){var i=new n.MiniDeferred;return setTimeout(i.resolve.bind(i,e),t),i.promise()},n.doFunction=function(t,e){return t.call(null,e)},n.simulateKeyEvent=function(t,e){var n=document.createEventObject?document.createEventObject():document.createEvent("Events");"function"==typeof n.initEvent&&n.initEvent("keydown",!0,!0),n.keyCode=e,n.which=e,"function"==typeof document.dispatchEvent?document.dispatchEvent(n):document.fireEvent("onkeydown",n)},n.doString=function(t){var e=n.keyCodeMap[t];if("number"==typeof e)return n.simulateKeyEvent("keydown",e)},n.doObject=function(){},n.MiniDeferred=function(){function t(){for(var t;o.length>0;)t=o.shift(),t.state===r&&t.func.apply(this,i)}function e(e,n,i){if("function"==typeof i){var u={state:e,async:n,func:i};o.push(u),0!==r&&t()}return this}function n(e){return 0===r?(r=e,i=Array.prototype.slice.call(arguments,1),t(),this):void 0}var i,o=[],r=0;return this.resolve=n.bind(this,1),this.reject=n.bind(this,2),this.promise=function(){return{done:this.done.bind(this),fail:this.fail.bind(this),always:this.always.bind(this)}},this.done=e.bind(this,1,!1),this.fail=e.bind(this,2,!1),this.always=function(t){return this.done.call(this,t),this.fail.call(this,t),this},this},n.defaults={debug:!1,stepDelay:0,iterationDelay:0,Deferred:n.MiniDeferred,doNumber:n.doNumber,doFunction:n.doFunction,doString:n.doString,doObject:n.doObject},n});