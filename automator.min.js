(function(a,b){if(typeof define==="function"&&define.amd){define(b)}else{if(typeof exports==="object"){module.exports=b()}else{a.Automator=b()}}}(this,function(){function b(e){return e&&typeof e.done==="function"&&typeof e.fail==="function"&&typeof e.always==="function"}function a(e){if("isArray" in Array){return Array.isArray(e)}return Object.prototype.toString.call(e)==="[object Array]"}function c(t){var r,l,j,s,n,p,q,o,m;t=typeof t==="object"?t:{};for(r in c.defaults){if(typeof t[r]==="undefined"||t[r===null]){t[r]=c.defaults[r]}}function f(){if(t.debug){var u=Array.prototype.slice.call(arguments);u.unshift("Automator.js: ");console.log.apply(console,u)}}function i(){l=[];j=[];s=0;n=1;p=0;o=new t.Deferred();m=false}function k(v,u){if(typeof u==="number"&&u>0){f("Sleeping for "+u+"ms");return setTimeout.bind(null,v,u)}return v}function h(v,u){if(b(u)){f("Deferring next step until the promise is resolved");u.always(v)}else{if(a(u)){if(u.length>0){f("Received back an array of interim actions, running them now: ",u);j.unshift(u)}v()}else{f("Passing value through to next step: ",u);v(u)}}}function g(B){var u,z,x,w,A,v,y;if(m){f("was killed by user, exiting.");return}if(s>=l.length){f("iteration "+p+" completed");if(typeof q==="function"){f("Executing iteration callback");A=q(p)}if(++p>=n){f("Done with iterations");h(o.resolve,A);return}f("Automator iteration "+p+" ready to start");s=0;y=k(g,t.iterationDelay);h(y,A);return}if(j.length>0){z=j[0].shift();if(j[0].length===0){j.shift()}}else{z=l[s++]}if(j.length>0){u=j[0][0]}else{u=l[s]}if(z==null){f("Skipping null action");g();return}f("Handling action: "+z);x=(typeof z);if(x==="number"){w=t.doNumber}else{if(x==="string"){w=t.doString}else{if(x==="function"){w=t.doFunction}else{throw"Unsupported type!"}}}if(x==="number"||typeof u==="number"||u==null){v=0}else{v=t.stepDelay}y=k(g,v);A=w.call(null,z,B);h(y,A)}function e(v){var w=[],A,z,x,y=-1,u=v.length;while(++y<u){A=v[y];if(typeof A==="string"){z=A.match(/(.*)+x(\d+)$/);if(z&&z.length===3){A=z[1];x=parseInt(z[2],10);while(x-->0){w.push(A)}continue}}w.push(A)}return w}this.automate=function(v,w,u){w=(typeof w==="number")?w:1;i();l=e(v);n=w;q=u;g();return o.promise()};this.kill=function(){m=true}}c.keyCodeMap={"0":48,"1":49,"2":50,"3":51,"4":52,"5":53,"6":54,"7":55,"8":56,"9":57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,left:37,up:38,right:39,down:40,enter:13,tab:9,ctrl:17,esc:27,space:32};c.doNumber=function(g,f){var e=new c.MiniDeferred();setTimeout(e.resolve.bind(e,f),g);return e.promise()};c.doFunction=function(e,f){return e.call(null,f)};c.simulateKeyEvent=function(e,g){var f=document.createEventObject?document.createEventObject():document.createEvent("Events");if(typeof f.initEvent==="function"){f.initEvent("keydown",true,true)}f.keyCode=g;f.which=g;if(typeof document.dispatchEvent==="function"){document.dispatchEvent(f)}else{document.fireEvent("onkeydown",f)}};c.doString=function(f,g){var e=c.keyCodeMap[f];if(typeof e!=="number"){return}return c.simulateKeyEvent("keydown",e)};c.doObject=function(e,f){};c.MiniDeferred=function d(){var i=[],f=0,e;function h(){var k;while(i.length>0){k=i.shift();if(k.state===f){k.func.apply(this,e)}}}function j(m,l,n){if(typeof n==="function"){var k={state:m,async:l,func:n};i.push(k);if(f!==0){h()}}return this}function g(k){if(f!==0){return}f=k;e=Array.prototype.slice.call(arguments,1);h();return this}this.resolve=g.bind(this,1);this.reject=g.bind(this,2);this.promise=function(){return{done:this.done.bind(this),fail:this.fail.bind(this),always:this.always.bind(this)}};this.done=j.bind(this,1,false);this.fail=j.bind(this,2,false);this.always=function(k){this.done.call(this,k);this.fail.call(this,k);return this};return this};c.defaults={debug:false,stepDelay:0,iterationDelay:0,Deferred:c.MiniDeferred,doNumber:c.doNumber,doFunction:c.doFunction,doString:c.doString,doObject:c.doObject};return c}));